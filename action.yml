name: 'Snyk Job Summary Action'
description: 'Add a Job Summary from Snyk reports, also uploads HTML reports to Github Packages'

inputs:
  DependenciesReportPath:
    description: 'json file path generated by snyk test command'
    required: false
    default: snyk_dependencies.json
  CodeReportPath:
    description: 'json file path generated by snyk code test command'
    required: false
    default: snyk_code.json
  ContainerReportPath:
    description: 'json file path generated by snyk container test command'
    required: false
    default: snyk_container.json
  ArtifactName:
    description: 'Artifact name to be uploaded'
    required: false
    default: snyk-details

runs:
  using: composite

  steps:
    - uses: actions/setup-node@v3

    - run: npm install snyk-to-html --location=global
      shell: bash

    - name: convert Snyk Dependencies json to html format
      run: snyk-to-html -i ${{inputs.DependenciesReportPath}} -o snyk_dependencies.html
      shell: bash

    - name: convert Snyk Code json to html format
      run: snyk-to-html -i ${{inputs.CodeReportPath}} -o snyk_code.html
      shell: bash

    - name: convert Snyk Container json to html format
      run: snyk-to-html -i ${{inputs.ContainerReportPath}} -o snyk_container.html
      shell: bash

    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v4
      with:
        name: ${{inputs.ArtifactName}}
        path: |
          snyk_dependencies.html
          snyk_code.html
          snyk_container.html
        retention-days: 60
        if-no-files-found: ignore

    - run: pip install mdutils
      name: install mdutils
      shell: bash

    - name: Run script
      run: python ${{ github.action_path }}/job_summary.py ${{inputs.DependenciesReportPath}} ${{inputs.CodeReportPath}} ${{inputs.ContainerReportPath}}
      shell: bash

    - name: Add output to Job Summary
      run: cat vulnerabilities.md >> $GITHUB_STEP_SUMMARY
      shell: bash
